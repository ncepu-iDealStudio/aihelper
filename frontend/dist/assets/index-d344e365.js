import{d as te,r as c,O as D,V as O,W as u,Y as n,_ as fe,e as k,l as ge,w as he,P as H,R as S,H as l,c as T,Z as P,a0 as K,a4 as Q,a3 as ye,a5 as we}from"./vue-401fb23c.js";import{u as be,a as Ce,g as X,d as xe,b as ee,m as R,p as ke,c as $e,l as U,e as Se,f as Te}from"./index-66da63bc.js";import{g as De,F as Ae,A as Ie,C as Me,a as Pe,K as Re,b as Ne,S as Be}from"./FileSaver.min-fddcbe53.js";import{v as Ue,h as Ee,w as Ve,x as Fe,y as We,z as ze,b as He,A as Ke,B as Oe,C as Le,o as Ge,e as je,D as Je,N,i as E}from"./naive_ui-f15aaf84.js";import{_ as Ze}from"./HistoryContent.vue_vue_type_script_setup_true_lang-77c29c33.js";import{g as qe}from"./conversation-74fd8a88.js";const Ye=te({__name:"StatusCard",emits:["chosePrompt"],setup(ae,{emit:V}){const v=c(!0),F=c(!1),W=c(!1),$=c(!0),b=c("prompt");function g(C=2,o=1,s=""){const d=[];if(o===1)for(let r=0;r<_.value.data.parent_result.length;r++)d.push({value:_.value.data.parent_result[r].prompt_id,label:_.value.data.parent_result[r].category,children:g(C,2,_.value.data.parent_result[r].prompt_id)});else if(o===C)for(let r=0;r<_.value.data.son_result.length;r++)_.value.data.son_result[r].prompt_parent_id===s&&d.push({value:_.value.data.son_result[r].prompt,label:_.value.data.son_result[r].title});return d}const _=c(),B=c();(async()=>{_.value=await De(),console.log(_.value.data,_.value.data.parent_result.length),B.value=g()})();const y=C=>{V("chosePrompt",C)},A=(C,o)=>{y(C)};return(C,o)=>{const s=Ue,d=Ee;return D(),O(d,{vertical:""},{default:u(()=>[n(s,{value:b.value,"onUpdate:value":[o[0]||(o[0]=r=>b.value=r),A],placeholder:"prompt","expand-trigger":W.value?"hover":"click",options:B.value,"check-strategy":v.value?"child":"all","show-path":F.value,clearable:"true",filterable:$.value},null,8,["value","expand-trigger","options","check-strategy","show-path","filterable"])]),_:1})}}}),Qe={class:"h-full flex flex-col md:flex-row md:space-x-4"},Xe={class:"md:w-1/4 md:min-w-1/4 w-full flex flex-col space-y-4 md:h-full"},et={key:0,class:"flex box-content m-2"},tt={class:"right-4 -top-12 lg:-right-10 lg:-top-8 ml-1 absolute"},at={class:"flex flex-row space-x-2 py-2 justify-center relative",style:{height:"25px"}},ot={class:"m-2 flex flex-row justify-between"},ct=te({__name:"index",setup(ae){const V=Ve(),{t:v}=fe(),F=c(),W=c(null),$=c(),b=be(),g=Ce(),_=c(!1),B=k(()=>_.value?"50vh":"24vh"),L=()=>{_.value=!_.value},y=c(!1),A=c(!1),C=k(()=>{var t,a,m,p;let e="";return((t=b.user)==null?void 0:t.available_ask_count)!=-1&&(e+=`${v("commons.availableAskCount")}: ${X((a=b.user)==null?void 0:a.available_ask_count)}   `),d.value&&d.value.model_name==="gpt-4"&&((m=b.user)==null?void 0:m.available_gpt4_ask_count)!=-1&&(e+=`${v("commons.availableGPT4AskCount")}: ${X((p=b.user)==null?void 0:p.available_gpt4_ask_count)}`),e}),o=c(null),s=c(null),d=k(()=>{var t,a;return((t=o.value)==null?void 0:t.conversation_id)===s.value?o.value:(a=g.conversations)==null?void 0:a.find(m=>m.conversation_id==s.value)}),r=c(""),x=c(null),f=c(null),G=k(()=>{var a;const e=(a=d.value)==null?void 0:a.conversation_id;if(!e)return[];let t=qe(e);return J.value.length>0&&(t=t.concat(J.value)),t}),oe=k(()=>{var a;const e=(a=g.conversations)==null?void 0:a.sort((m,p)=>{if(!m.create_time)return-1;if(!p.create_time)return 1;const h=new Date(m.create_time);return new Date(p.create_time).getTime()-h.getTime()}),t=e==null?void 0:e.map(m=>({label:()=>ge(Fe,null,{default:()=>m.title}),key:m.conversation_id,disabled:y.value==!0,extra:()=>xe(m,ne,le,de)}));return o.value&&(t==null||t.unshift({label:o.value.title,key:o.value.conversation_id,disabled:y.value==!0})),t}),ne=e=>{if(!e)return;const t=ee.info({title:v("commons.confirmDialogTitle"),content:v("tips.deleteConversation"),positiveText:v("commons.confirm"),negativeText:v("commons.cancel"),onPositiveClick:()=>(t.loading=!0,new Promise(a=>{g.deleteConversation(e).then(()=>{R.success(v("tips.deleteConversationSuccess")),s.value==e&&(s.value=null)}).catch(()=>{R.error(v("tips.deleteConversationFailed"))}).finally(()=>{t.loading=!1,a(!0)})}))})},le=e=>{e&&ke(e,async t=>{await g.changeConversationTitle(e,t)},()=>{R.success(v("tips.changeConversationTitleSuccess"))},()=>{R.error(v("tips.changeConversationTitleFailed"))})},j=k(()=>{var e,t,a;if((e=d.value)!=null&&e.conversation_id)return(a=g.conversationDetailMap[(t=d.value)==null?void 0:t.conversation_id])==null?void 0:a.current_node}),J=k(()=>{const e=[];return x.value&&e.findIndex(t=>{var a;return t.id===((a=x.value)==null?void 0:a.id)})===-1&&e.push(x.value),f.value&&e.findIndex(t=>{var a;return t.id===((a=f.value)==null?void 0:a.id)})===-1&&e.push(f.value),e});he(s,(e,t)=>{e!="new_conversation"&&(re(e),localStorage.removeItem("title"),localStorage.setItem("id",String(e)),console.log(localStorage.getItem("id")))});const se=e=>{r.value=e,console.log(e)},re=e=>{y.value||!e||(y.value=!0,A.value=!0,U.start(),g.fetchConversationHistory(e).then(()=>{}).catch(t=>{console.log(t)}).finally(()=>{y.value=!1,A.value=!1,U.finish()}))},Z=k(()=>y.value||s.value==null||r.value===null||r.value.trim()==""),q=()=>{o.value||Se(async(e,t)=>{var a;console.log(e,t),o.value={conversation_id:"new_conversation",title:e||`New Chat ${new Date().toLocaleString()} - ${(a=b.user)==null?void 0:a.username}`,model_name:t||"text-davinci-002-render-sha",create_time:new Date().toISOString()},s.value="new_conversation",localStorage.removeItem("id"),localStorage.setItem("title",String(o.value.title))})},ie=e=>{e.preventDefault(),Y()},z=c(!0),ue=()=>{$.value.scrollTo({left:0,top:$.value.$refs.scrollbarInstRef.contentRef.scrollHeight})},ce=()=>{$.value.scrollTo({left:0,top:$.value.$refs.scrollbarInstRef.contentRef.scrollHeight,behavior:"smooth"})},Y=async()=>{var I;if(Z.value||y.value)return;U.start(),y.value=!0;const e=r.value;r.value="";const t={message:e};o.value?(t.new_title=o.value.title,t.model_name=o.value.model_name):(t.conversation_id=d.value.conversation_id,t.parent_id=j.value);const a=Math.random().toString(36).substring(2,16);x.value={id:`send_${a}`,message:e,author_role:"user",parent:j.value,children:[`recv_${a}`]},f.value={id:`recv_${a}`,message:"",author_role:"assistent",parent:`send_${a}`,children:[],typing:!0,model_slug:(I=d.value)==null?void 0:I.model_name};const m=Te();let p=null;console.log("Connecting to",m,t);const h=new WebSocket(m);h.onopen=w=>{h.send(JSON.stringify(t))},h.onmessage=w=>{const i=JSON.parse(w.data);i.type&&(i.type==="waiting"?(f.value.message=v(i.tip),i.waiting_count&&(f.value.message+=`(${i.waiting_count})`)):i.type==="message"?(f.value.message=i.message,f.value.id=i.parent_id,f.value.model_slug=i.model_name,o.value&&(o.value.conversation_id=i.conversation_id,s.value!==o.value.conversation_id&&(s.value=o.value.conversation_id))):i.type==="error"&&(f.value.message=`${v(i.tip)}: ${i.message}}`,console.error(i.tip,i.message),i.message&&(p=i.message)),z.value&&ue())},h.onclose=async w=>{if(f.value.typing=!1,console.log("WebSocket connection is closed",w),w.code===1e3){if(o.value){await g.fetchAllConversations(),s.value=o.value.conversation_id;const i=new Date(o.value.create_time).getTime()/1e3;g.$patch({conversationDetailMap:{[s.value]:{id:s.value,title:o.value.title,model_name:o.value.model_name,create_time:i,mapping:{},current_node:null}}}),g.addMessageToConversation(s.value,x.value,f.value),o.value=null}else f.value.id.startsWith("recv")||g.addMessageToConversation(s.value,x.value,f.value);x.value=null,f.value=null}else ee.error({title:v("errors.askError"),content:p!=null?`[${w.code}] ${v(w.reason)}: ${p}`:`[${w.code}] ${v(w.reason)}`,positiveText:v("commons.withdrawMessage"),onPositiveClick:()=>{x.value=null,f.value=null}});await b.fetchUserInfo(),U.finish(),y.value=!1},h.onerror=w=>{console.error("WebSocket error:",w)}},de=()=>{if(!d.value){R.error(v("tips.pleaseSelectConversation"));return}let e=`# ${d.value.title}

`;const t=new Date(d.value.create_time+"Z").toLocaleString();e+=`Date: ${t}
Model: ${$e(d.value.model_name)}
`,e+=`generated by [ChatGPT Web Share](https://github.com/moeakwak/chatgpt-web-share)

`,e+=`---

`;let a=0;for(const p of G.value)if(p.author_role==="user"){let h=p.message.trim().split(`
`)[0];h.length>=50&&(h=h.slice(0,47)+"..."),e+=`## ${++a}. ${h}

`,e+=`### User

${p.message}

`}else e+=`### ChatGPT

${p.message}

`,e+=`---

`;const m=new Blob([e],{type:"text/plain;charset=utf-8"});Ae.saveAs(m,`${d.value.title} - ChatGPT history.md`)},ve=c(),me=c(!1);return g.fetchAllConversations().then(()=>{}),(e,t)=>{const a=We,m=ze,p=He,h=Ke,I=Oe,w=Le,i=Ge,pe=je,_e=Je;return D(),H("div",{class:"flex-grow mb-4",ref_key:"rootRef",ref:F},[S("div",Qe,[S("div",Xe,[n(Ye,{onChosePrompt:se}),n(p,{class:"h-full flex-col left-col","content-style":"padding: 4px;"},{default:u(()=>[o.value?K("",!0):(D(),H("div",et,[n(l(N),{secondary:"",strong:"",type:"primary",class:"flex-1",onClick:q,disabled:y.value},{icon:u(()=>[n(l(E),{class:""},{default:u(()=>[n(l(Ie))]),_:1})]),default:u(()=>[T(" "+P(e.$t("commons.newConversation")),1)]),_:1},8,["disabled"])])),n(m,{class:"max-h-30 md:max-h-max md:min-h-0 md:flex-grow md:overflow-y-auto"},{default:u(()=>[n(a,{"content-style":{backgroundColor:"red"},ref_key:"menuRef",ref:W,disabled:y.value,options:l(oe),"root-indent":18,value:s.value,"onUpdate:value":t[0]||(t[0]=M=>s.value=M)},null,8,["disabled","options","value"])]),_:1})]),_:1})]),n(p,{class:"md:w-3/4 h-full",bordered:!0,"content-style":"padding: 0; display: flex; flex-direction: column;"},{default:u(()=>[s.value?(D(),O(m,{key:0,class:"h-140 sm:h-0 flex-grow",ref_key:"historyRef",ref:$,"content-style":{height:"100%"}},{default:u(()=>[n(Ze,{ref_key:"historyContentRef",ref:ve,messages:l(G),fullscreen:!1,"model-name":l(d).model_name,"show-tips":me.value,loading:A.value},null,8,["messages","model-name","show-tips","loading"])]),_:1},512)):s.value?K("",!0):(D(),H("div",{key:1,class:"flex-grow flex flex-col justify-center",style:Q({backgroundColor:l(V).cardColor})},[l(d)?K("",!0):(D(),O(h,{key:0,description:e.$t("tips.loadConversation")},{icon:u(()=>[n(l(E),null,{default:u(()=>[n(l(Me))]),_:1})]),extra:u(()=>[n(l(N),{onClick:q},{default:u(()=>[T(P(e.$t("tips.newConversation")),1)]),_:1})]),_:1},8,["description"]))],4)),S("div",{class:"flex flex-col relative",style:Q({height:l(B)})},[n(I),S("div",tt,[n(l(N),{onClick:ce,secondary:"",circle:"",size:"small"},{icon:u(()=>[n(l(Pe))]),_:1})]),S("div",at,[n(l(N),{onClick:L,quaternary:"",circle:"",size:"small",class:"absolute left-1"},{icon:u(()=>[n(l(E),{component:_.value?l(Re):l(Ne)},null,8,["component"])]),_:1}),n(i,null,{trigger:u(()=>[n(w,{value:z.value,"onUpdate:value":t[1]||(t[1]=M=>z.value=M),size:"small",class:"absolute left-8 top-3"},{icon:u(()=>[T("A")]),_:1},8,["value"])]),default:u(()=>[T(" "+P(e.$t("tips.autoScrolling")),1)]),_:1}),n(l(N),{disabled:l(Z),onClick:Y,class:"absolute right-1",type:"primary",size:"small"},{icon:u(()=>[n(l(E),null,{default:u(()=>[n(l(Be))]),_:1})]),default:u(()=>[T(P(e.$t("commons.send"))+" ",1)]),_:1},8,["disabled"])]),n(pe,{value:r.value,"onUpdate:value":t[2]||(t[2]=M=>r.value=M),class:"flex-1",type:"textarea",bordered:!1,placeholder:e.$t("tips.sendMessage"),onKeydown:ye(we(ie,["shift"]),["enter"])},null,8,["value","placeholder","onKeydown"]),S("div",ot,[n(_e,{depth:"3",class:"hidden sm:block"},{default:u(()=>[T(P(l(C)),1)]),_:1})])],4)]),_:1})])],512)}}});export{ct as default};
//# sourceMappingURL=index-d344e365.js.map

import{d as te,r as u,O as D,V as O,W as i,Y as n,_ as fe,e as k,l as ge,w as he,P as H,R as S,H as f,c as T,Z as P,a0 as K,a4 as Q,a3 as ye,a5 as we}from"./vue-c727071f.js";import{u as be,a as Ce,g as X,d as xe,b as ee,m as R,p as ke,c as $e,l as U,e as Se,f as Te}from"./index-c5ed8602.js";import{g as De}from"./prompt-af8b533b.js";import{v as Ae,h as Ie,w as Me,x as Pe,y as Re,z as Ne,b as Be,A as Ue,B as Ee,C as Ve,o as Fe,e as We,D as ze,N,i as E}from"./naive_ui-1fdfc3bf.js";import{F as He,A as Ke,C as Oe,a as Le,K as Ge,b as je,S as Je}from"./FileSaver.min-3c525abe.js";import{_ as Ze}from"./HistoryContent.vue_vue_type_script_setup_true_lang-6de79309.js";import{g as qe}from"./conversation-45822fe5.js";const Ye=te({__name:"StatusCard",emits:["chosePrompt"],setup(ae,{emit:V}){const v=u(!0),F=u(!1),W=u(!1),$=u(!0),b=u("prompt");function g(C=2,o=1,l=""){const c=[];if(o===1)for(let s=0;s<p.value.data.parent_result.length;s++)c.push({value:p.value.data.parent_result[s].prompt_id,label:p.value.data.parent_result[s].category,children:g(C,2,p.value.data.parent_result[s].prompt_id)});else if(o===C)for(let s=0;s<p.value.data.son_result.length;s++)p.value.data.son_result[s].prompt_parent_id===l&&c.push({value:p.value.data.son_result[s].prompt,label:p.value.data.son_result[s].title});return c}const p=u(),B=u();(async()=>{p.value=await De(),console.log(p.value.data,p.value.data.parent_result.length),B.value=g()})();const y=C=>{V("chosePrompt",C)},A=(C,o)=>{y(C)};return(C,o)=>{const l=Ae,c=Ie;return D(),O(c,{vertical:""},{default:i(()=>[n(l,{value:b.value,"onUpdate:value":[o[0]||(o[0]=s=>b.value=s),A],placeholder:"prompt","expand-trigger":W.value?"hover":"click",options:B.value,"check-strategy":v.value?"child":"all","show-path":F.value,clearable:"true",filterable:$.value},null,8,["value","expand-trigger","options","check-strategy","show-path","filterable"])]),_:1})}}}),Qe={class:"h-full flex flex-col md:flex-row md:space-x-4"},Xe={class:"md:w-1/4 md:min-w-1/4 w-full flex flex-col space-y-4 md:h-full"},et={key:0,class:"flex box-content m-2"},tt={class:"right-4 -top-12 lg:-right-10 lg:-top-8 ml-1 absolute"},at={class:"flex flex-row space-x-2 py-2 justify-center relative",style:{height:"25px"}},ot={class:"m-2 flex flex-row justify-between"},vt=te({__name:"index",setup(ae){const V=Me(),{t:v}=fe(),F=u(),W=u(null),$=u(),b=be(),g=Ce(),p=u(!1),B=k(()=>p.value?"50vh":"24vh"),L=()=>{p.value=!p.value},y=u(!1),A=u(!1),C=k(()=>{var t,a,d,m;let e="";return((t=b.user)==null?void 0:t.available_ask_count)!=-1&&(e+=`${v("commons.availableAskCount")}: ${X((a=b.user)==null?void 0:a.available_ask_count)}   `),c.value&&c.value.model_name==="gpt-4"&&((d=b.user)==null?void 0:d.available_gpt4_ask_count)!=-1&&(e+=`${v("commons.availableGPT4AskCount")}: ${X((m=b.user)==null?void 0:m.available_gpt4_ask_count)}`),e}),o=u(null),l=u(null),c=k(()=>{var t,a;return((t=o.value)==null?void 0:t.conversation_id)===l.value?o.value:(a=g.conversations)==null?void 0:a.find(d=>d.conversation_id==l.value)}),s=u(""),x=u(null),_=u(null),G=k(()=>{var a;const e=(a=c.value)==null?void 0:a.conversation_id;if(!e)return[];let t=qe(e);return J.value.length>0&&(t=t.concat(J.value)),t}),oe=k(()=>{var a;const e=(a=g.conversations)==null?void 0:a.sort((d,m)=>{if(!d.create_time)return-1;if(!m.create_time)return 1;const h=new Date(d.create_time);return new Date(m.create_time).getTime()-h.getTime()}),t=e==null?void 0:e.map(d=>({label:()=>ge(Pe,null,{default:()=>d.title}),key:d.conversation_id,disabled:y.value==!0,extra:()=>xe(d,ne,le,ve)}));return o.value&&(t==null||t.unshift({label:o.value.title,key:o.value.conversation_id,disabled:y.value==!0})),t}),ne=e=>{if(!e)return;const t=ee.info({title:v("commons.confirmDialogTitle"),content:v("tips.deleteConversation"),positiveText:v("commons.confirm"),negativeText:v("commons.cancel"),onPositiveClick:()=>(t.loading=!0,new Promise(a=>{g.deleteConversation(e).then(()=>{R.success(v("tips.deleteConversationSuccess")),l.value==e&&(l.value=null)}).catch(()=>{R.error(v("tips.deleteConversationFailed"))}).finally(()=>{t.loading=!1,a(!0)})}))})},le=e=>{e&&ke(e,async t=>{await g.changeConversationTitle(e,t)},()=>{R.success(v("tips.changeConversationTitleSuccess"))},()=>{R.error(v("tips.changeConversationTitleFailed"))})},j=k(()=>{var e,t,a;if((e=c.value)!=null&&e.conversation_id)return(a=g.conversationDetailMap[(t=c.value)==null?void 0:t.conversation_id])==null?void 0:a.current_node}),J=k(()=>{const e=[];return x.value&&e.findIndex(t=>{var a;return t.id===((a=x.value)==null?void 0:a.id)})===-1&&e.push(x.value),_.value&&e.findIndex(t=>{var a;return t.id===((a=_.value)==null?void 0:a.id)})===-1&&e.push(_.value),e});he(l,(e,t)=>{e!="new_conversation"&&(re(e),localStorage.removeItem("title"),localStorage.setItem("id",String(e)),console.log(localStorage.getItem("id")))});const se=e=>{s.value=e,console.log(e)},re=e=>{y.value||!e||(y.value=!0,A.value=!0,U.start(),g.fetchConversationHistory(e).then(()=>{}).catch(t=>{console.log(t)}).finally(()=>{y.value=!1,A.value=!1,U.finish()}))},Z=k(()=>y.value||l.value==null||s.value===null||s.value.trim()==""),q=()=>{o.value||Se(async(e,t)=>{var a;console.log(e,t),o.value={conversation_id:"new_conversation",title:e||`New Chat ${new Date().toLocaleString()} - ${(a=b.user)==null?void 0:a.username}`,model_name:t||"text-davinci-002-render-sha",create_time:new Date().toISOString()},l.value="new_conversation",localStorage.removeItem("id"),localStorage.setItem("title",String(o.value.title))})},ie=e=>{e.preventDefault(),Y()},z=u(!0),ue=()=>{$.value.scrollTo({left:0,top:$.value.$refs.scrollbarInstRef.contentRef.scrollHeight})},ce=()=>{$.value.scrollTo({left:0,top:$.value.$refs.scrollbarInstRef.contentRef.scrollHeight,behavior:"smooth"})},Y=async()=>{var I;if(Z.value||y.value)return;U.start(),y.value=!0;const e=s.value;s.value="";const t={message:e};o.value?(t.new_title=o.value.title,t.model_name=o.value.model_name):(t.conversation_id=c.value.conversation_id,t.parent_id=j.value);const a=Math.random().toString(36).substring(2,16);x.value={id:`send_${a}`,message:e,author_role:"user",parent:j.value,children:[`recv_${a}`]},_.value={id:`recv_${a}`,message:"",author_role:"assistent",parent:`send_${a}`,children:[],typing:!0,model_slug:(I=c.value)==null?void 0:I.model_name};const d=Te();let m=null;console.log("Connecting to",d,t);const h=new WebSocket(d);h.onopen=w=>{h.send(JSON.stringify(t))},h.onmessage=w=>{const r=JSON.parse(w.data);r.type&&(r.type==="waiting"?(_.value.message=v(r.tip),r.waiting_count&&(_.value.message+=`(${r.waiting_count})`)):r.type==="message"?(_.value.message=r.message,_.value.id=r.parent_id,_.value.model_slug=r.model_name,o.value&&(o.value.conversation_id=r.conversation_id,l.value!==o.value.conversation_id&&(l.value=o.value.conversation_id))):r.type==="error"&&(_.value.message=`${v(r.tip)}: ${r.message}}`,console.error(r.tip,r.message),r.message&&(m=r.message)),z.value&&ue())},h.onclose=async w=>{if(_.value.typing=!1,console.log("WebSocket connection is closed",w),w.code===1e3){if(o.value){await g.fetchAllConversations(),l.value=o.value.conversation_id;const r=new Date(o.value.create_time).getTime()/1e3;g.$patch({conversationDetailMap:{[l.value]:{id:l.value,title:o.value.title,model_name:o.value.model_name,create_time:r,mapping:{},current_node:null}}}),g.addMessageToConversation(l.value,x.value,_.value),o.value=null}else _.value.id.startsWith("recv")||g.addMessageToConversation(l.value,x.value,_.value);x.value=null,_.value=null}else ee.error({title:v("errors.askError"),content:m!=null?`[${w.code}] ${v(w.reason)}: ${m}`:`[${w.code}] ${v(w.reason)}`,positiveText:v("commons.withdrawMessage"),onPositiveClick:()=>{x.value=null,_.value=null}});await b.fetchUserInfo(),U.finish(),y.value=!1},h.onerror=w=>{console.error("WebSocket error:",w)}},ve=()=>{if(!c.value){R.error(v("tips.pleaseSelectConversation"));return}let e=`# ${c.value.title}

`;const t=new Date(c.value.create_time+"Z").toLocaleString();e+=`Date: ${t}
Model: ${$e(c.value.model_name)}
`,e+=`generated by [ChatGPT Web Share](https://github.com/moeakwak/chatgpt-web-share)

`,e+=`---

`;let a=0;for(const m of G.value)if(m.author_role==="user"){let h=m.message.trim().split(`
`)[0];h.length>=50&&(h=h.slice(0,47)+"..."),e+=`## ${++a}. ${h}

`,e+=`### User

${m.message}

`}else e+=`### ChatGPT

${m.message}

`,e+=`---

`;const d=new Blob([e],{type:"text/plain;charset=utf-8"});He.saveAs(d,`${c.value.title} - ChatGPT history.md`)},de=u(),me=u(!1);return g.fetchAllConversations().then(()=>{}),(e,t)=>{const a=Re,d=Ne,m=Be,h=Ue,I=Ee,w=Ve,r=Fe,pe=We,_e=ze;return D(),H("div",{class:"flex-grow mb-4",ref_key:"rootRef",ref:F},[S("div",Qe,[S("div",Xe,[n(Ye,{onChosePrompt:se}),n(m,{class:"h-full flex-col left-col","content-style":"padding: 4px;"},{default:i(()=>[o.value?K("",!0):(D(),H("div",et,[n(f(N),{secondary:"",strong:"",type:"primary",class:"flex-1",onClick:q,disabled:y.value},{icon:i(()=>[n(f(E),{class:""},{default:i(()=>[n(f(Ke))]),_:1})]),default:i(()=>[T(" "+P(e.$t("commons.newConversation")),1)]),_:1},8,["disabled"])])),n(d,{class:"max-h-30 md:max-h-max md:min-h-0 md:flex-grow md:overflow-y-auto"},{default:i(()=>[n(a,{"content-style":{backgroundColor:"red"},ref_key:"menuRef",ref:W,disabled:y.value,options:oe.value,"root-indent":18,value:l.value,"onUpdate:value":t[0]||(t[0]=M=>l.value=M)},null,8,["disabled","options","value"])]),_:1})]),_:1})]),n(m,{class:"md:w-3/4 h-full",bordered:!0,"content-style":"padding: 0; display: flex; flex-direction: column;"},{default:i(()=>[l.value?(D(),O(d,{key:0,class:"h-140 sm:h-0 flex-grow",ref_key:"historyRef",ref:$,"content-style":{height:"100%"}},{default:i(()=>[n(Ze,{ref_key:"historyContentRef",ref:de,messages:G.value,fullscreen:!1,"model-name":c.value.model_name,"show-tips":me.value,loading:A.value},null,8,["messages","model-name","show-tips","loading"])]),_:1},512)):l.value?K("",!0):(D(),H("div",{key:1,class:"flex-grow flex flex-col justify-center",style:Q({backgroundColor:f(V).cardColor})},[c.value?K("",!0):(D(),O(h,{key:0,description:e.$t("tips.loadConversation")},{icon:i(()=>[n(f(E),null,{default:i(()=>[n(f(Oe))]),_:1})]),extra:i(()=>[n(f(N),{onClick:q},{default:i(()=>[T(P(e.$t("tips.newConversation")),1)]),_:1})]),_:1},8,["description"]))],4)),S("div",{class:"flex flex-col relative",style:Q({height:B.value})},[n(I),S("div",tt,[n(f(N),{onClick:ce,secondary:"",circle:"",size:"small"},{icon:i(()=>[n(f(Le))]),_:1})]),S("div",at,[n(f(N),{onClick:L,quaternary:"",circle:"",size:"small",class:"absolute left-1"},{icon:i(()=>[n(f(E),{component:p.value?f(Ge):f(je)},null,8,["component"])]),_:1}),n(r,null,{trigger:i(()=>[n(w,{value:z.value,"onUpdate:value":t[1]||(t[1]=M=>z.value=M),size:"small",class:"absolute left-8 top-3"},{icon:i(()=>[T("A")]),_:1},8,["value"])]),default:i(()=>[T(" "+P(e.$t("tips.autoScrolling")),1)]),_:1}),n(f(N),{disabled:Z.value,onClick:Y,class:"absolute right-1",type:"primary",size:"small"},{icon:i(()=>[n(f(E),null,{default:i(()=>[n(f(Je))]),_:1})]),default:i(()=>[T(P(e.$t("commons.send"))+" ",1)]),_:1},8,["disabled"])]),n(pe,{value:s.value,"onUpdate:value":t[2]||(t[2]=M=>s.value=M),class:"flex-1",type:"textarea",bordered:!1,placeholder:e.$t("tips.sendMessage"),onKeydown:ye(we(ie,["shift"]),["enter"])},null,8,["value","placeholder","onKeydown"]),S("div",ot,[n(_e,{depth:"3",class:"hidden sm:block"},{default:i(()=>[T(P(C.value),1)]),_:1})])],4)]),_:1})])],512)}}});export{vt as default};
//# sourceMappingURL=index-6d5b111e.js.map

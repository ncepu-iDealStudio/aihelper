import{d as Q,r as p,O as k,V as j,W as r,Y as o,l as z,f as ne,_ as re,e as D,P as F,R,H as v,k as se,v as oe,Z as B,a4 as q,w as he,c as O,a0 as ae,F as Ne,X as Le,a3 as ye,a5 as Be}from"./vue-c727071f.js";import{i as Ie,M as ze,b as le,u as be,_ as je,m as U,c as Ce,h as we,g as ge,p as Fe,l as Y,j as He,k as Oe}from"./index-c5ed8602.js";import{g as Ue}from"./prompt-af8b533b.js";import{v as Ke,h as We,N as I,i as K,j as qe,e as xe,k as Ge,w as ie,n as Je,D as ke,E as Xe,A as $e,x as Ze,y as Ye,z as Qe,b as et,B as tt,C as st,o as ot}from"./naive_ui-1fdfc3bf.js";import{F as nt,A as at,C as lt,a as rt,K as it,b as ct,S as ut}from"./FileSaver.min-3c525abe.js";import{P as dt,C as pt,a as mt,b as vt,c as _t}from"./conversation-45822fe5.js";const ft=Q({__name:"StatusCard",emits:["chosePrompt"],setup($,{emit:m}){const i=p(!0),n=p(!1),b=p(!1),N=p(!0),P=p("prompt");function f(y=2,C=1,d=""){const l=[];if(C===1)for(let t=0;t<u.value.data.parent_result.length;t++)l.push({value:u.value.data.parent_result[t].prompt_id,label:u.value.data.parent_result[t].category,children:f(y,C+1,u.value.data.parent_result[t].prompt_id)});else if(C===y)for(let t=0;t<u.value.data.son_result.length;t++)u.value.data.son_result[t].prompt_parent_id===d&&l.push({value:u.value.data.son_result[t].prompt,label:u.value.data.son_result[t].title});return l}const u=p(),T=p();(async()=>{u.value=await Ue(),T.value=f()})();const A=y=>{m("chosePrompt",y)},_=(y,C)=>{A(y)};return(y,C)=>{const d=Ke,l=We;return k(),j(l,{vertical:""},{default:r(()=>[o(d,{value:P.value,"onUpdate:value":[C[0]||(C[0]=t=>P.value=t),_],placeholder:"prompt","expand-trigger":b.value?"hover":"click",options:T.value,"check-strategy":i.value?"child":"all","show-path":n.value,clearable:"true",filterable:N.value},null,8,["value","expand-trigger","options","check-strategy","show-path","filterable"])]),_:1})}}}),V=Ie.global.t,gt=($,m,i,n)=>z(qe,{trigger:"hover",options:[{label:V("commons.delete"),key:"delete",props:{onClick:()=>m($.chat_id)}},{label:V("commons.rename"),key:"rename",props:{onClick:()=>i($.chat_id)}},{label:V("commons.download"),key:"download",props:{onClick:()=>n()}}]},{default:()=>z(I,{size:"small",quaternary:!0,circle:!0},{default:()=>z(K,null,{default:()=>z(ze)})})}),ht=$=>{var n,b;const m=be();let i=[];return $==="conversation"?i=[{label:V("commons.shaModel"),value:"text-davinci-002-render-sha"}]:i=[{label:"gpt-3.5-turbo",value:"gpt-3.5-turbo"},{label:"gpt-3.5-turbo-0301",value:"gpt-3.5-turbo-0301"},{label:"gpt-4",value:"gpt-4"},{label:"gpt-4-0314",value:"gpt-4-0314"},{label:"gpt-4-32k",value:"gpt-4-32k"},{label:"gpt-4-32k-0314",value:"gpt-4-32k-0314"}],(n=m.user)!=null&&n.can_use_paid&&i.push({label:V("commons.paidModel"),value:"text-davinci-002-render-paid"}),(b=m.user)!=null&&b.can_use_gpt4&&i.push({label:V("commons.gpt4Model"),value:"gpt-4"}),i},yt=$=>{let m="",i="";const n=le.info({title:V("commons.newConversation"),positiveText:V("commons.confirm"),negativeText:V("commons.cancel"),content:()=>z("div",{style:"display: flex; flex-direction: column; gap: 16px;"},[z(xe,{onInput:b=>m=b,autofocus:!0,placeholder:V("tips.conversationTitle")}),z(Ge,{placeholder:V("tips.whetherUsePaidModel"),"onUpdate:value":b=>i=b,options:ht("conversationv3")})]),onPositiveClick(){return n.loading=!0,new Promise(b=>{$(m,i).then(()=>{b(!0)}).catch(()=>{b(!0)}).finally(()=>{n.loading=!1})})}})},bt={class:"w-10 ml-0 md:ml-2 mt-3"},Ct={class:"mx-0 md:mx-4 w-full"},wt=["innerHTML"],xt={key:1},kt=["src"],$t={class:"hide-in-print"},Tt=Q({__name:"MessageRow",props:{message:{}},setup($){const m=$;let i,n=p(!1);ne(()=>{je(()=>import("./markdown-446d4431.js"),["assets/markdown-446d4431.js","assets/naive_ui-1fdfc3bf.js","assets/vue-c727071f.js"]).then(d=>{i=d.default,n.value=!0})});const{t:b}=re(),N=ie();let P=null;const f=p(),u=p(!1),T=()=>{u.value=!u.value},W=D(()=>m.message.author_role=="user"?N.value.bodyColor:N.value.actionColor),A=D(()=>{if(!n.value)return"";let d="";if(m.message.is_image){const l=m.message.message,t="",c="";d=i.render(`![${t}](${l} ${c})`)}else d=i.render(m.message.message||"");return _(d)});function _(d){const t=new DOMParser().parseFromString(d,"text/html"),c=t.getElementsByTagName("pre");for(let g=0;g<c.length;g++){const H=c[g],G=Object.assign(document.createElement("button"),{innerHTML:"",className:"hljs-copy-button hide-in-print"});G.dataset.copied="false",H.classList.add("hljs-copy-wrapper"),H.style.setProperty("--hljs-theme-background",window.getComputedStyle(H).backgroundColor),H.appendChild(G)}return new XMLSerializer().serializeToString(t.documentElement)}ne(()=>{if(!f.value)return;const d=(l,t)=>{for(const c of l)c.type==="childList"&&y()};P=new MutationObserver(d),P.observe(f.value,{subtree:!0,childList:!0}),y()});const y=()=>{var l;const d=(l=f.value)==null?void 0:l.querySelectorAll("pre");if(d)for(const t of d)for(const c of t.querySelectorAll("button"))c.onclick=()=>{navigator.clipboard&&navigator.clipboard.writeText(c.parentElement.textContent||"").then(function(){c.innerHTML="Copied!",c.dataset.copied="true";let x=Object.assign(document.createElement("div"),{role:"status",className:"hljs-copy-alert",innerHTML:"Copied to clipboard"});c.parentElement.appendChild(x),setTimeout(()=>{x&&(c.innerHTML="Copy",c.dataset.copied="false",c.parentElement.removeChild(x),x=null)},2e3)}).then()}},C=()=>{navigator.clipboard&&navigator.clipboard.writeText(m.message.message||"").then(()=>{U.success(b("commons.copiedToClipboard"))}).then()};return(d,l)=>{const t=K,c=Je,x=I;return k(),F("div",{class:"flex flex-col md:flex-row py-2 md:py-4 px-5 md:px-4 max-w-full relative",style:q({backgroundColor:W.value})},[R("div",bt,[m.message.author_role=="user"?(k(),j(c,{key:0,size:"small"},{default:r(()=>[o(t,null,{default:r(()=>[o(v(dt))]),_:1})]),_:1})):(k(),j(c,{key:1,size:"small",src:"/chatgpt-icon.svg"}))]),R("div",Ct,[se(R("div",{ref_key:"contentRef",ref:f,class:"message-content w-full",innerHTML:A.value},null,8,wt),[[oe,!u.value]]),m.message.is_image?se((k(),F("div",xt,[R("img",{src:m.message.message},null,8,kt)],512)),[[oe,u.value]]):se((k(),F("div",{key:0,class:"my-3 w-full whitespace-pre-line text-gray-500"},B(m.message.message),513)),[[oe,u.value]]),R("div",$t,[o(x,{text:"",ghost:"",type:"tertiary",size:"tiny",class:"mt-2 -ml-2 absolute bottom-3 right-3 md:bottom-1 md:right-1",onClick:C},{default:r(()=>[o(t,null,{default:r(()=>[o(v(pt))]),_:1})]),_:1}),o(x,{text:"",ghost:"",size:"tiny",type:u.value?"success":"tertiary",class:"mt-2 -ml-2 absolute bottom-3 right-9 md:bottom-1 md:right-5",onClick:T},{default:r(()=>[o(t,null,{default:r(()=>[o(v(mt))]),_:1})]),_:1},8,["type"])])])],4)}}});const Mt={key:0},St=Q({__name:"HistoryContent",props:{messages:{},modelName:{},fullscreen:{type:Boolean},showTips:{type:Boolean},loading:{type:Boolean}},setup($,{expose:m}){const i=$,{t:n}=re(),b=ie(),N=p(),P=p(),f=p(!1),u=D(()=>i.modelName?i.modelName:vt(i.messages));he(()=>i.fullscreen,()=>{T(i.showTips)});const T=A=>{const _=document.getElementById("app"),y=document.body,C=N.value;f.value?(P.value.appendChild(C),_&&(_.style.display="block")):(P.value=C.parentElement,y.insertBefore(C,y.firstChild),_&&(_.style.display="none"),C.focus(),A&&U.success(n("tips.pressEscToExitFullscreen"),{duration:2e3})),f.value=!f.value};return i.fullscreen&&T(i.showTips),m({focus:()=>{N.value.focus()},toggleFullscreenHistory:T}),(A,_)=>{const y=ke,C=K,d=I,l=Xe,t=$e;return k(),F("div",{ref_key:"contentRef",ref:N,id:"print-content",class:"flex flex-col h-full",onKeyup:_[0]||(_[0]=ye(c=>T(!0),["esc"])),tabindex:"0",style:{outline:"none"}},[i.loading?(k(),j(t,{key:1,class:"h-full flex justify-center",style:q({backgroundColor:v(b).cardColor}),description:A.$t("tips.loading")},{icon:r(()=>[o(l,{size:"medium"})]),_:1},8,["style","description"])):(k(),F("div",Mt,[R("div",{class:"flex justify-center py-4 px-4 max-w-full relative",style:q({backgroundColor:v(b).baseColor})},[o(y,null,{default:r(()=>[O(B(A.$t("commons.currentConversationModel"))+": "+B(v(Ce)(u.value)),1)]),_:1}),f.value?(k(),j(d,{key:0,class:"absolute left-4 hide-in-print",text:"",onClick:T},{icon:r(()=>[o(C,null,{default:r(()=>[o(v(_t))]),_:1})]),_:1})):ae("",!0)],4),(k(!0),F(Ne,null,Le(A.messages,c=>(k(),j(Tt,{message:c,key:c.id},null,8,["message"]))),128))]))],544)}}});function Pt($){const m=we();let i=[];if(!$)return[];const n=m.conversationV3DetailMap[$];return n&&(i=n.messageList),i}const Et={class:"h-full flex flex-col md:flex-row md:space-x-4"},Rt={class:"md:w-1/4 md:min-w-1/4 w-full flex flex-col space-y-4 md:h-full"},At={class:"flex box-content m-2"},Dt={class:"right-4 -top-12 lg:-right-10 lg:-top-8 ml-1 absolute"},Vt={class:"flex flex-row space-x-2 py-2 justify-center relative",style:{height:"20px"}},Nt={class:"m-2 flex flex-row justify-between"},Ht=Q({__name:"index",setup($){const m=e=>{c.value=e,console.log(e)},i=ie(),{t:n}=re(),b=p(),N=p(null),P=p(),f=be(),u=we(),T=p(!1),W=D(()=>T.value?"50vh":"24vh"),A=()=>{T.value=!T.value},_=p(!1),y=p(!1),C=D(()=>{var s,a,E,w;let e="";return((s=f.user)==null?void 0:s.available_ask_count)!=-1&&(e+=`${n("commons.availableAskCount")}: ${ge((a=f.user)==null?void 0:a.available_ask_count)}   `),t.value&&t.value.model_name==="gpt-4"&&((E=f.user)==null?void 0:E.available_gpt4_ask_count)!=-1&&(e+=`${n("commons.availableGPT4AskCount")}: ${ge((w=f.user)==null?void 0:w.available_gpt4_ask_count)}`),e}),d=p(null),l=p(null),t=D(()=>{var s,a;return((s=d.value)==null?void 0:s.chat_id)===l.value?d.value:(a=u.conversationsv3)==null?void 0:a.find(E=>E.chat_id==l.value)}),c=p(""),x=p(null),g=p(null),H=D(()=>{var a;const e=(a=t.value)==null?void 0:a.chat_id;if(!e)return[];let s=Pt(e);return console.log("result1",s),ce.value.length>0&&(s=s.concat(ce.value)),s}),G=D(()=>{var s;return(s=u.conversationsv3)==null?void 0:s.map(a=>({label:()=>z(Ze,null,{default:()=>a.title}),key:a.chat_id,disabled:_.value==!0,extra:()=>gt(a,Te,Me,Ae)}))}),Te=e=>{if(!e)return;const s=le.info({title:n("commons.confirmDialogTitle"),content:n("tips.deleteConversation"),positiveText:n("commons.confirm"),negativeText:n("commons.cancel"),onPositiveClick:()=>(s.loading=!0,new Promise(a=>{u.deleteConversationV3(e).then(()=>{U.success(n("tips.deleteConversationSuccess")),l.value==e&&(l.value=null)}).catch(()=>{U.error(n("tips.deleteConversationFailed"))}).finally(()=>{s.loading=!1,a(!0)})}))})},Me=e=>{e&&Fe(e,async s=>{await u.changeConversationV3Title(e,s)},()=>{U.success(n("tips.changeConversationTitleSuccess"))},()=>{U.error(n("tips.changeConversationTitleFailed"))})};D(()=>{var e,s,a;if((e=t.value)!=null&&e.chat_id)return(a=u.conversationV3DetailMap[(s=t.value)==null?void 0:s.chat_id])==null?void 0:a.current_node});const ce=D(()=>{const e=[];return x.value&&e.findIndex(s=>{var a;return s.id===((a=x.value)==null?void 0:a.id)})===-1&&e.push(x.value),g.value&&e.findIndex(s=>{var a;return s.id===((a=g.value)==null?void 0:a.id)})===-1&&e.push(g.value),e});he(l,(e,s)=>{Se(e)});const Se=e=>{_.value||!e||(_.value=!0,y.value=!0,Y.start(),u.fetchConversationV3History(e).finally(()=>{_.value=!1,y.value=!1,Y.finish()}))},ue=D(()=>_.value||l.value==null||c.value===null||c.value.trim()==""),de=()=>{d.value||yt(async(e,s)=>{var E;const a={title:e,model_name:s};He((E=f.$state.user)==null?void 0:E.id,a).then(w=>{var S;console.log("res",w);const M=w.data;l.value=M.chat_id,d.value={chat_id:M.chat_id,title:e||`New Chat ${new Date().toLocaleString()} - ${(S=f.user)==null?void 0:S.username}`,model_name:s||"text-davinci-002-render-sha",create_time:new Date().toISOString()},me()})})},Pe=e=>{e.preventDefault(),pe()},ee=p(!0),Ee=()=>{P.value.scrollTo({left:0,top:P.value.$refs.scrollbarInstRef.contentRef.scrollHeight})},Re=()=>{P.value.scrollTo({left:0,top:P.value.$refs.scrollbarInstRef.contentRef.scrollHeight,behavior:"smooth"})},pe=async()=>{if(ue.value||_.value)return;Y.start(),_.value=!0;const e=c.value;c.value="";const s={message:e};s.chat_id=t.value.chat_id;const a=Math.random().toString(36).substring(2,16);x.value={id:`send_${a}`,message:e,author_role:"user"},g.value={id:`recv_${a}`,message:"",author_role:"assistent",typing:!0,is_image:!1};const E=Oe();let w=null;const M=new WebSocket(E);M.onopen=S=>{M.send(JSON.stringify(s))},M.onmessage=S=>{const h=JSON.parse(S.data);h.type&&(h.type==="waiting"?(g.value.message=n(h.tip),h.waiting_count&&(g.value.message+=`(${h.waiting_count})`)):h.type==="message"?(g.value.message=h.message,g.value.id=h.chat_id,g.value.is_image=h.is_image,d.value&&(d.value.chat_id=h.chat_id,l.value!==d.value.chat_id&&(l.value=d.value.chat_id))):h.type==="error"&&(g.value.message=`${n(h.tip)}: ${h.message}}`,h.message&&(w=h.message)),ee.value&&Ee())},M.onclose=async S=>{var h,J,X,Z,L,ve,_e,fe;if(g.value.typing=!1,S.code===1e3){await u.fetchAllConversationsv3((h=f.$state.user)==null?void 0:h.id);const te=u.conversationV3DetailMap[l.value];(X=te.messageList)==null||X.push({id:a,message:(J=x.value)==null?void 0:J.message,author_role:"user",is_image:!1}),console.log(g.value),(Z=g.value)!=null&&Z.is_image?(ve=te.messageList)==null||ve.push({id:a,message:"data:image/jpeg;base64,"+((L=g.value)==null?void 0:L.message),is_image:!0}):(fe=te.messageList)==null||fe.push({id:a,message:(_e=g.value)==null?void 0:_e.message,is_image:!1}),x.value=null,g.value=null}else le.error({title:n("errors.askError"),content:w!=null?`[${S.code}] ${n(S.reason)}: ${w}`:`[${S.code}] ${n(S.reason)}`,positiveText:n("commons.withdrawMessage"),onPositiveClick:()=>{x.value=null,g.value=null}});await f.fetchUserInfo(),Y.finish(),_.value=!1},M.onerror=S=>{console.error("WebSocket error:",S)}},Ae=()=>{if(!t.value){U.error(n("tips.pleaseSelectConversation"));return}let e=`# ${t.value.title}

`;const s=new Date(t.value.create_time+"Z").toLocaleString();e+=`Date: ${s}
Model: ${Ce(t.value.model_name)}
`,e+=`generated by [ChatGPT Web Share](https://github.com/moeakwak/chatgpt-web-share)

`,e+=`---

`;let a=0;for(const w of H.value)if(w.author_role==="user"){let M=w.message.trim().split(`
`)[0];M.length>=50&&(M=M.slice(0,47)+"..."),e+=`## ${++a}. ${M}

`,e+=`### User

${w.message}

`}else e+=`### ChatGPT

${w.message}

`,e+=`---

`;const E=new Blob([e],{type:"text/plain;charset=utf-8"});nt.saveAs(E,`${t.value.title} - ChatGPT history.md`)},De=p(),Ve=p(!1),me=()=>{u.fetchAllConversationsv3()};return ne(()=>{me()}),(e,s)=>{const a=Ye,E=Qe,w=et,M=$e,S=tt,h=st,J=ot,X=xe,Z=ke;return k(),F("div",{class:"flex-grow mb-4",ref_key:"rootRef",ref:b},[R("div",Et,[R("div",Rt,[o(ft,{onChosePrompt:m}),o(w,{class:"h-full flex-col left-col","content-style":"padding: 4px;"},{default:r(()=>[R("div",At,[o(v(I),{secondary:"",strong:"",type:"primary",class:"flex-1",onClick:de,disabled:_.value},{icon:r(()=>[o(v(K),{class:""},{default:r(()=>[o(v(at))]),_:1})]),default:r(()=>[O(" "+B(e.$t("commons.newConversation")),1)]),_:1},8,["disabled"])]),o(E,{class:"max-h-30 md:max-h-max md:min-h-0 md:flex-grow md:overflow-y-auto"},{default:r(()=>[o(a,{"content-style":{backgroundColor:"red"},ref_key:"menuRef",ref:N,disabled:_.value,options:G.value,"root-indent":18,value:l.value,"onUpdate:value":s[0]||(s[0]=L=>l.value=L)},null,8,["disabled","options","value"])]),_:1})]),_:1})]),o(w,{class:"md:w-3/4 h-full",bordered:!0,"content-style":"padding: 0; display: flex; flex-direction: column;"},{default:r(()=>[l.value?(k(),j(E,{key:0,class:"h-140 sm:h-0 flex-grow",ref_key:"historyRef",ref:P,"content-style":{height:"100%"}},{default:r(()=>[o(St,{ref_key:"historyContentRef",ref:De,messages:H.value,fullscreen:!1,"model-name":t.value.model_name,"show-tips":Ve.value,loading:y.value},null,8,["messages","model-name","show-tips","loading"])]),_:1},512)):l.value?ae("",!0):(k(),F("div",{key:1,class:"flex-grow flex flex-col justify-center",style:q({backgroundColor:v(i).cardColor})},[t.value?ae("",!0):(k(),j(M,{key:0,description:e.$t("tips.loadConversation")},{icon:r(()=>[o(v(K),null,{default:r(()=>[o(v(lt))]),_:1})]),extra:r(()=>[o(v(I),{onClick:de},{default:r(()=>[O(B(e.$t("tips.newConversation")),1)]),_:1})]),_:1},8,["description"]))],4)),R("div",{class:"flex flex-col relative",style:q({height:W.value})},[o(S),R("div",Dt,[o(v(I),{onClick:Re,secondary:"",circle:"",size:"small"},{icon:r(()=>[o(v(rt))]),_:1})]),R("div",Vt,[o(v(I),{onClick:A,quaternary:"",circle:"",size:"small",class:"absolute left-1"},{icon:r(()=>[o(v(K),{component:T.value?v(it):v(ct)},null,8,["component"])]),_:1}),o(J,null,{trigger:r(()=>[o(h,{value:ee.value,"onUpdate:value":s[1]||(s[1]=L=>ee.value=L),size:"small",class:"absolute left-8 top-3"},{icon:r(()=>[O("A")]),_:1},8,["value"])]),default:r(()=>[O(" "+B(e.$t("tips.autoScrolling")),1)]),_:1}),o(v(I),{disabled:ue.value,onClick:pe,class:"absolute right-1",type:"primary",size:"small"},{icon:r(()=>[o(v(K),null,{default:r(()=>[o(v(ut))]),_:1})]),default:r(()=>[O(B(e.$t("commons.send"))+" ",1)]),_:1},8,["disabled"])]),o(X,{value:c.value,"onUpdate:value":s[2]||(s[2]=L=>c.value=L),class:"flex-1",type:"textarea",bordered:!1,placeholder:e.$t("tips.sendMessage"),onKeydown:ye(Be(Pe,["shift"]),["enter"])},null,8,["value","placeholder","onKeydown"]),R("div",Nt,[o(Z,{depth:"3",class:"hidden sm:block"},{default:r(()=>[O(B(C.value),1)]),_:1})])],4)]),_:1})])],512)}}});export{Ht as default};
//# sourceMappingURL=index-e9301701.js.map

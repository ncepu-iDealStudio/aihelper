import{d as Q,r as m,O as $,V as j,W as i,Y as o,l as I,f as ne,_ as re,e as A,P as F,R,H as l,k as se,z as oe,Z as B,a4 as q,w as he,c as O,a0 as ae,F as Ne,X as Le,a3 as ye,a5 as Be}from"./vue-401fb23c.js";import{i as ze,M as Ie,b as le,u as be,_ as je,m as U,c as Ce,h as we,g as ge,p as Fe,l as Y,j as He,k as Oe}from"./index-66da63bc.js";import{g as Ue,F as Ke,A as We,C as qe,a as Ge,K as Je,b as Xe,S as Ze}from"./FileSaver.min-fddcbe53.js";import{v as Ye,h as Qe,N as z,i as K,j as et,e as xe,k as tt,w as ie,n as st,D as ke,E as ot,A as $e,x as nt,y as at,z as lt,b as rt,B as it,C as ct,o as ut}from"./naive_ui-f15aaf84.js";import{P as dt,C as pt,a as mt,b as vt,c as _t}from"./conversation-74fd8a88.js";const ft=Q({__name:"StatusCard",emits:["chosePrompt"],setup(x,{emit:v}){const c=m(!0),n=m(!1),b=m(!1),V=m(!0),P=m("prompt");function f(y=2,C=1,p=""){const r=[];if(C===1)for(let t=0;t<d.value.data.parent_result.length;t++)r.push({value:d.value.data.parent_result[t].prompt_id,label:d.value.data.parent_result[t].category,children:f(y,C+1,d.value.data.parent_result[t].prompt_id)});else if(C===y)for(let t=0;t<d.value.data.son_result.length;t++)d.value.data.son_result[t].prompt_parent_id===p&&r.push({value:d.value.data.son_result[t].prompt,label:d.value.data.son_result[t].title});return r}const d=m(),T=m();(async()=>{d.value=await Ue(),T.value=f()})();const N=y=>{v("chosePrompt",y)},_=(y,C)=>{N(y)};return(y,C)=>{const p=Ye,r=Qe;return $(),j(r,{vertical:""},{default:i(()=>[o(p,{value:P.value,"onUpdate:value":[C[0]||(C[0]=t=>P.value=t),_],placeholder:"prompt","expand-trigger":b.value?"hover":"click",options:T.value,"check-strategy":c.value?"child":"all","show-path":n.value,clearable:"true",filterable:V.value},null,8,["value","expand-trigger","options","check-strategy","show-path","filterable"])]),_:1})}}}),D=ze.global.t,gt=(x,v,c,n)=>I(et,{trigger:"hover",options:[{label:D("commons.delete"),key:"delete",props:{onClick:()=>v(x.chat_id)}},{label:D("commons.rename"),key:"rename",props:{onClick:()=>c(x.chat_id)}},{label:D("commons.download"),key:"download",props:{onClick:()=>n()}}]},{default:()=>I(z,{size:"small",quaternary:!0,circle:!0},{default:()=>I(K,null,{default:()=>I(Ie)})})}),ht=x=>{var n,b;const v=be();let c=[];return x==="conversation"?c=[{label:D("commons.shaModel"),value:"text-davinci-002-render-sha"}]:c=[{label:"gpt-3.5-turbo",value:"gpt-3.5-turbo"},{label:"gpt-3.5-turbo-0301",value:"gpt-3.5-turbo-0301"},{label:"gpt-4",value:"gpt-4"},{label:"gpt-4-0314",value:"gpt-4-0314"},{label:"gpt-4-32k",value:"gpt-4-32k"},{label:"gpt-4-32k-0314",value:"gpt-4-32k-0314"}],(n=v.user)!=null&&n.can_use_paid&&c.push({label:D("commons.paidModel"),value:"text-davinci-002-render-paid"}),(b=v.user)!=null&&b.can_use_gpt4&&c.push({label:D("commons.gpt4Model"),value:"gpt-4"}),c},yt=x=>{let v="",c="";const n=le.info({title:D("commons.newConversation"),positiveText:D("commons.confirm"),negativeText:D("commons.cancel"),content:()=>I("div",{style:"display: flex; flex-direction: column; gap: 16px;"},[I(xe,{onInput:b=>v=b,autofocus:!0,placeholder:D("tips.conversationTitle")}),I(tt,{placeholder:D("tips.whetherUsePaidModel"),"onUpdate:value":b=>c=b,options:ht("conversationv3")})]),onPositiveClick(){return n.loading=!0,new Promise(b=>{x(v,c).then(()=>{b(!0)}).catch(()=>{b(!0)}).finally(()=>{n.loading=!1})})}})},bt={class:"w-10 ml-0 md:ml-2 mt-3"},Ct={class:"mx-0 md:mx-4 w-full"},wt=["innerHTML"],xt={key:1},kt=["src"],$t={class:"hide-in-print"},Tt=Q({__name:"MessageRow",props:{message:null},setup(x){const v=x;let c,n=m(!1);ne(()=>{je(()=>import("./markdown-89a0a5a0.js"),["assets/markdown-89a0a5a0.js","assets/naive_ui-f15aaf84.js","assets/vue-401fb23c.js"]).then(p=>{c=p.default,n.value=!0})});const{t:b}=re(),V=ie();let P=null;const f=m(),d=m(!1),T=()=>{d.value=!d.value},W=A(()=>v.message.author_role=="user"?V.value.bodyColor:V.value.actionColor),N=A(()=>{if(!n.value)return"";let p="";if(v.message.is_image){const r=v.message.message,t="",u="";p=c.render(`![${t}](${r} ${u})`)}else p=c.render(v.message.message||"");return _(p)});function _(p){const t=new DOMParser().parseFromString(p,"text/html"),u=t.getElementsByTagName("pre");for(let g=0;g<u.length;g++){const H=u[g],G=Object.assign(document.createElement("button"),{innerHTML:"",className:"hljs-copy-button hide-in-print"});G.dataset.copied="false",H.classList.add("hljs-copy-wrapper"),H.style.setProperty("--hljs-theme-background",window.getComputedStyle(H).backgroundColor),H.appendChild(G)}return new XMLSerializer().serializeToString(t.documentElement)}ne(()=>{if(!f.value)return;const p=(r,t)=>{for(const u of r)u.type==="childList"&&y()};P=new MutationObserver(p),P.observe(f.value,{subtree:!0,childList:!0}),y()});const y=()=>{var r;const p=(r=f.value)==null?void 0:r.querySelectorAll("pre");if(p)for(const t of p)for(const u of t.querySelectorAll("button"))u.onclick=()=>{navigator.clipboard&&navigator.clipboard.writeText(u.parentElement.textContent||"").then(function(){u.innerHTML="Copied!",u.dataset.copied="true";let k=Object.assign(document.createElement("div"),{role:"status",className:"hljs-copy-alert",innerHTML:"Copied to clipboard"});u.parentElement.appendChild(k),setTimeout(()=>{k&&(u.innerHTML="Copy",u.dataset.copied="false",u.parentElement.removeChild(k),k=null)},2e3)}).then()}},C=()=>{navigator.clipboard&&navigator.clipboard.writeText(v.message.message||"").then(()=>{U.success(b("commons.copiedToClipboard"))}).then()};return(p,r)=>{const t=K,u=st,k=z;return $(),F("div",{class:"flex flex-col md:flex-row py-2 md:py-4 px-5 md:px-4 max-w-full relative",style:q({backgroundColor:l(W)})},[R("div",bt,[v.message.author_role=="user"?($(),j(u,{key:0,size:"small"},{default:i(()=>[o(t,null,{default:i(()=>[o(l(dt))]),_:1})]),_:1})):($(),j(u,{key:1,size:"small",src:"/chatgpt-icon.svg"}))]),R("div",Ct,[se(R("div",{ref_key:"contentRef",ref:f,class:"message-content w-full",innerHTML:l(N)},null,8,wt),[[oe,!d.value]]),v.message.is_image?se(($(),F("div",xt,[R("img",{src:v.message.message},null,8,kt)],512)),[[oe,d.value]]):se(($(),F("div",{key:0,class:"my-3 w-full whitespace-pre-line text-gray-500"},B(v.message.message),513)),[[oe,d.value]]),R("div",$t,[o(k,{text:"",ghost:"",type:"tertiary",size:"tiny",class:"mt-2 -ml-2 absolute bottom-3 right-3 md:bottom-1 md:right-1",onClick:C},{default:i(()=>[o(t,null,{default:i(()=>[o(l(pt))]),_:1})]),_:1}),o(k,{text:"",ghost:"",size:"tiny",type:d.value?"success":"tertiary",class:"mt-2 -ml-2 absolute bottom-3 right-9 md:bottom-1 md:right-5",onClick:T},{default:i(()=>[o(t,null,{default:i(()=>[o(l(mt))]),_:1})]),_:1},8,["type"])])])],4)}}});const Mt={key:0},St=Q({__name:"HistoryContent",props:{messages:null,modelName:null,fullscreen:{type:Boolean},showTips:{type:Boolean},loading:{type:Boolean}},setup(x,{expose:v}){const c=x,{t:n}=re(),b=ie(),V=m(),P=m(),f=m(!1),d=A(()=>c.modelName?c.modelName:vt(c.messages));he(()=>c.fullscreen,()=>{T(c.showTips)});const T=N=>{const _=document.getElementById("app"),y=document.body,C=V.value;f.value?(P.value.appendChild(C),_&&(_.style.display="block")):(P.value=C.parentElement,y.insertBefore(C,y.firstChild),_&&(_.style.display="none"),C.focus(),N&&U.success(n("tips.pressEscToExitFullscreen"),{duration:2e3})),f.value=!f.value};return c.fullscreen&&T(c.showTips),v({focus:()=>{V.value.focus()},toggleFullscreenHistory:T}),(N,_)=>{const y=ke,C=K,p=z,r=ot,t=$e;return $(),F("div",{ref_key:"contentRef",ref:V,id:"print-content",class:"flex flex-col h-full",onKeyup:_[0]||(_[0]=ye(u=>T(!0),["esc"])),tabindex:"0",style:{outline:"none"}},[c.loading?($(),j(t,{key:1,class:"h-full flex justify-center",style:q({backgroundColor:l(b).cardColor}),description:N.$t("tips.loading")},{icon:i(()=>[o(r,{size:"medium"})]),_:1},8,["style","description"])):($(),F("div",Mt,[R("div",{class:"flex justify-center py-4 px-4 max-w-full relative",style:q({backgroundColor:l(b).baseColor})},[o(y,null,{default:i(()=>[O(B(N.$t("commons.currentConversationModel"))+": "+B(l(Ce)(l(d))),1)]),_:1}),f.value?($(),j(p,{key:0,class:"absolute left-4 hide-in-print",text:"",onClick:T},{icon:i(()=>[o(C,null,{default:i(()=>[o(l(_t))]),_:1})]),_:1})):ae("",!0)],4),($(!0),F(Ne,null,Le(x.messages,u=>($(),j(Tt,{message:u,key:u.id},null,8,["message"]))),128))]))],544)}}});function Pt(x){const v=we();let c=[];if(!x)return[];const n=v.conversationV3DetailMap[x];return n&&(c=n.messageList),c}const Et={class:"h-full flex flex-col md:flex-row md:space-x-4"},Rt={class:"md:w-1/4 md:min-w-1/4 w-full flex flex-col space-y-4 md:h-full"},At={class:"flex box-content m-2"},Dt={class:"right-4 -top-12 lg:-right-10 lg:-top-8 ml-1 absolute"},Vt={class:"flex flex-row space-x-2 py-2 justify-center relative",style:{height:"20px"}},Nt={class:"m-2 flex flex-row justify-between"},Ft=Q({__name:"index",setup(x){const v=e=>{u.value=e,console.log(e)},c=ie(),{t:n}=re(),b=m(),V=m(null),P=m(),f=be(),d=we(),T=m(!1),W=A(()=>T.value?"50vh":"24vh"),N=()=>{T.value=!T.value},_=m(!1),y=m(!1),C=A(()=>{var s,a,E,w;let e="";return((s=f.user)==null?void 0:s.available_ask_count)!=-1&&(e+=`${n("commons.availableAskCount")}: ${ge((a=f.user)==null?void 0:a.available_ask_count)}   `),t.value&&t.value.model_name==="gpt-4"&&((E=f.user)==null?void 0:E.available_gpt4_ask_count)!=-1&&(e+=`${n("commons.availableGPT4AskCount")}: ${ge((w=f.user)==null?void 0:w.available_gpt4_ask_count)}`),e}),p=m(null),r=m(null),t=A(()=>{var s,a;return((s=p.value)==null?void 0:s.chat_id)===r.value?p.value:(a=d.conversationsv3)==null?void 0:a.find(E=>E.chat_id==r.value)}),u=m(""),k=m(null),g=m(null),H=A(()=>{var a;const e=(a=t.value)==null?void 0:a.chat_id;if(!e)return[];let s=Pt(e);return console.log("result1",s),ce.value.length>0&&(s=s.concat(ce.value)),s}),G=A(()=>{var s;return(s=d.conversationsv3)==null?void 0:s.map(a=>({label:()=>I(nt,null,{default:()=>a.title}),key:a.chat_id,disabled:_.value==!0,extra:()=>gt(a,Te,Me,Ae)}))}),Te=e=>{if(!e)return;const s=le.info({title:n("commons.confirmDialogTitle"),content:n("tips.deleteConversation"),positiveText:n("commons.confirm"),negativeText:n("commons.cancel"),onPositiveClick:()=>(s.loading=!0,new Promise(a=>{d.deleteConversationV3(e).then(()=>{U.success(n("tips.deleteConversationSuccess")),r.value==e&&(r.value=null)}).catch(()=>{U.error(n("tips.deleteConversationFailed"))}).finally(()=>{s.loading=!1,a(!0)})}))})},Me=e=>{e&&Fe(e,async s=>{await d.changeConversationV3Title(e,s)},()=>{U.success(n("tips.changeConversationTitleSuccess"))},()=>{U.error(n("tips.changeConversationTitleFailed"))})};A(()=>{var e,s,a;if((e=t.value)!=null&&e.chat_id)return(a=d.conversationV3DetailMap[(s=t.value)==null?void 0:s.chat_id])==null?void 0:a.current_node});const ce=A(()=>{const e=[];return k.value&&e.findIndex(s=>{var a;return s.id===((a=k.value)==null?void 0:a.id)})===-1&&e.push(k.value),g.value&&e.findIndex(s=>{var a;return s.id===((a=g.value)==null?void 0:a.id)})===-1&&e.push(g.value),e});he(r,(e,s)=>{Se(e)});const Se=e=>{_.value||!e||(_.value=!0,y.value=!0,Y.start(),d.fetchConversationV3History(e).finally(()=>{_.value=!1,y.value=!1,Y.finish()}))},ue=A(()=>_.value||r.value==null||u.value===null||u.value.trim()==""),de=()=>{p.value||yt(async(e,s)=>{var E;const a={title:e,model_name:s};Oe((E=f.$state.user)==null?void 0:E.id,a).then(w=>{var S;console.log("res",w);const M=w.data;r.value=M.chat_id,p.value={chat_id:M.chat_id,title:e||`New Chat ${new Date().toLocaleString()} - ${(S=f.user)==null?void 0:S.username}`,model_name:s||"text-davinci-002-render-sha",create_time:new Date().toISOString()},me()})})},Pe=e=>{e.preventDefault(),pe()},ee=m(!0),Ee=()=>{P.value.scrollTo({left:0,top:P.value.$refs.scrollbarInstRef.contentRef.scrollHeight})},Re=()=>{P.value.scrollTo({left:0,top:P.value.$refs.scrollbarInstRef.contentRef.scrollHeight,behavior:"smooth"})},pe=async()=>{if(ue.value||_.value)return;Y.start(),_.value=!0;const e=u.value;u.value="";const s={message:e};s.chat_id=t.value.chat_id;const a=Math.random().toString(36).substring(2,16);k.value={id:`send_${a}`,message:e,author_role:"user"},g.value={id:`recv_${a}`,message:"",author_role:"assistent",typing:!0,is_image:!1};const E=He();let w=null;const M=new WebSocket(E);M.onopen=S=>{M.send(JSON.stringify(s))},M.onmessage=S=>{const h=JSON.parse(S.data);h.type&&(h.type==="waiting"?(g.value.message=n(h.tip),h.waiting_count&&(g.value.message+=`(${h.waiting_count})`)):h.type==="message"?(g.value.message=h.message,g.value.id=h.chat_id,g.value.is_image=h.is_image,p.value&&(p.value.chat_id=h.chat_id,r.value!==p.value.chat_id&&(r.value=p.value.chat_id))):h.type==="error"&&(g.value.message=`${n(h.tip)}: ${h.message}}`,h.message&&(w=h.message)),ee.value&&Ee())},M.onclose=async S=>{var h,J,X,Z,L,ve,_e,fe;if(g.value.typing=!1,S.code===1e3){await d.fetchAllConversationsv3((h=f.$state.user)==null?void 0:h.id);const te=d.conversationV3DetailMap[r.value];(X=te.messageList)==null||X.push({id:a,message:(J=k.value)==null?void 0:J.message,author_role:"user",is_image:!1}),console.log(g.value),(Z=g.value)!=null&&Z.is_image?(ve=te.messageList)==null||ve.push({id:a,message:"data:image/jpeg;base64,"+((L=g.value)==null?void 0:L.message),is_image:!0}):(fe=te.messageList)==null||fe.push({id:a,message:(_e=g.value)==null?void 0:_e.message,is_image:!1}),k.value=null,g.value=null}else le.error({title:n("errors.askError"),content:w!=null?`[${S.code}] ${n(S.reason)}: ${w}`:`[${S.code}] ${n(S.reason)}`,positiveText:n("commons.withdrawMessage"),onPositiveClick:()=>{k.value=null,g.value=null}});await f.fetchUserInfo(),Y.finish(),_.value=!1},M.onerror=S=>{console.error("WebSocket error:",S)}},Ae=()=>{if(!t.value){U.error(n("tips.pleaseSelectConversation"));return}let e=`# ${t.value.title}

`;const s=new Date(t.value.create_time+"Z").toLocaleString();e+=`Date: ${s}
Model: ${Ce(t.value.model_name)}
`,e+=`generated by [ChatGPT Web Share](https://github.com/moeakwak/chatgpt-web-share)

`,e+=`---

`;let a=0;for(const w of H.value)if(w.author_role==="user"){let M=w.message.trim().split(`
`)[0];M.length>=50&&(M=M.slice(0,47)+"..."),e+=`## ${++a}. ${M}

`,e+=`### User

${w.message}

`}else e+=`### ChatGPT

${w.message}

`,e+=`---

`;const E=new Blob([e],{type:"text/plain;charset=utf-8"});Ke.saveAs(E,`${t.value.title} - ChatGPT history.md`)},De=m(),Ve=m(!1),me=()=>{d.fetchAllConversationsv3()};return ne(()=>{me()}),(e,s)=>{const a=at,E=lt,w=rt,M=$e,S=it,h=ct,J=ut,X=xe,Z=ke;return $(),F("div",{class:"flex-grow mb-4",ref_key:"rootRef",ref:b},[R("div",Et,[R("div",Rt,[o(ft,{onChosePrompt:v}),o(w,{class:"h-full flex-col left-col","content-style":"padding: 4px;"},{default:i(()=>[R("div",At,[o(l(z),{secondary:"",strong:"",type:"primary",class:"flex-1",onClick:de,disabled:_.value},{icon:i(()=>[o(l(K),{class:""},{default:i(()=>[o(l(We))]),_:1})]),default:i(()=>[O(" "+B(e.$t("commons.newConversation")),1)]),_:1},8,["disabled"])]),o(E,{class:"max-h-30 md:max-h-max md:min-h-0 md:flex-grow md:overflow-y-auto"},{default:i(()=>[o(a,{"content-style":{backgroundColor:"red"},ref_key:"menuRef",ref:V,disabled:_.value,options:l(G),"root-indent":18,value:r.value,"onUpdate:value":s[0]||(s[0]=L=>r.value=L)},null,8,["disabled","options","value"])]),_:1})]),_:1})]),o(w,{class:"md:w-3/4 h-full",bordered:!0,"content-style":"padding: 0; display: flex; flex-direction: column;"},{default:i(()=>[r.value?($(),j(E,{key:0,class:"h-140 sm:h-0 flex-grow",ref_key:"historyRef",ref:P,"content-style":{height:"100%"}},{default:i(()=>[o(St,{ref_key:"historyContentRef",ref:De,messages:l(H),fullscreen:!1,"model-name":l(t).model_name,"show-tips":Ve.value,loading:y.value},null,8,["messages","model-name","show-tips","loading"])]),_:1},512)):r.value?ae("",!0):($(),F("div",{key:1,class:"flex-grow flex flex-col justify-center",style:q({backgroundColor:l(c).cardColor})},[l(t)?ae("",!0):($(),j(M,{key:0,description:e.$t("tips.loadConversation")},{icon:i(()=>[o(l(K),null,{default:i(()=>[o(l(qe))]),_:1})]),extra:i(()=>[o(l(z),{onClick:de},{default:i(()=>[O(B(e.$t("tips.newConversation")),1)]),_:1})]),_:1},8,["description"]))],4)),R("div",{class:"flex flex-col relative",style:q({height:l(W)})},[o(S),R("div",Dt,[o(l(z),{onClick:Re,secondary:"",circle:"",size:"small"},{icon:i(()=>[o(l(Ge))]),_:1})]),R("div",Vt,[o(l(z),{onClick:N,quaternary:"",circle:"",size:"small",class:"absolute left-1"},{icon:i(()=>[o(l(K),{component:T.value?l(Je):l(Xe)},null,8,["component"])]),_:1}),o(J,null,{trigger:i(()=>[o(h,{value:ee.value,"onUpdate:value":s[1]||(s[1]=L=>ee.value=L),size:"small",class:"absolute left-8 top-3"},{icon:i(()=>[O("A")]),_:1},8,["value"])]),default:i(()=>[O(" "+B(e.$t("tips.autoScrolling")),1)]),_:1}),o(l(z),{disabled:l(ue),onClick:pe,class:"absolute right-1",type:"primary",size:"small"},{icon:i(()=>[o(l(K),null,{default:i(()=>[o(l(Ze))]),_:1})]),default:i(()=>[O(B(e.$t("commons.send"))+" ",1)]),_:1},8,["disabled"])]),o(X,{value:u.value,"onUpdate:value":s[2]||(s[2]=L=>u.value=L),class:"flex-1",type:"textarea",bordered:!1,placeholder:e.$t("tips.sendMessage"),onKeydown:ye(Be(Pe,["shift"]),["enter"])},null,8,["value","placeholder","onKeydown"]),R("div",Nt,[o(Z,{depth:"3",class:"hidden sm:block"},{default:i(()=>[O(B(l(C)),1)]),_:1})])],4)]),_:1})])],512)}}});export{Ft as default};
//# sourceMappingURL=index-94796473.js.map

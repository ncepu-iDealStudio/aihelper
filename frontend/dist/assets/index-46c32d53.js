import{d as te,_ as ne,r as p,N as I,U as H,V as s,X as n,Q as u,G as a,c as C,Y as g,e as k,l as he,w as ye,O as z,a0 as K,a4 as Y,a3 as we,a5 as be}from"./vue-33c36bbc.js";import{u as Ce,a as xe,g as Z,d as $e,b as ee,m as U,p as Se,c as ke,l as F,e as Te,f as De}from"./index-32f447af.js";import{g as Ie}from"./status-99e733ef.js";import{e as E,_ as Me,a as Ae,s as Ne,t as Re,b as oe,v as Ue,w as Be,x as Ee,y as Fe,z as je,A as Pe,B as Ve,m as We,g as ze,C as Ke,N as B}from"./naive_ui-45b37a56.js";import{M as G,E as Ge,Q as He,F as Oe,A as Le,C as Qe,a as Je,K as qe,b as Xe,S as Ye}from"./FileSaver.min-9dc4c357.js";import{_ as Ze}from"./HistoryContent.vue_vue_type_script_setup_true_lang-1bb7594e.js";import{g as et}from"./conversation-c341f96a.js";const tt={class:"flex flex-row justify-between content-center"},nt={class:"flex flex-row justify-between content-center"},ot={class:"flex flex-row justify-between content-center"},st={class:"flex flex-row justify-between content-center"},at={class:"flex flex-row justify-between content-center"},lt=te({__name:"StatusCard",setup(se){ne();const $=p({}),i=p(!1),j=d=>{d.length>0?(i.value=!0,M()):i.value=!1},M=()=>{i.value&&Ie().then(d=>{$.value=d.data})};return M(),setInterval(M,5e3),(d,T)=>{const _=E,x=Me,P=Ae,V=Ne,w=Re,A=oe;return I(),H(A,{"content-style":"padding: 0;"},{default:s(()=>[n(w,{"onUpdate:expandedNames":j},{default:s(()=>[n(V,{title:d.$t("commons.serverStatus"),name:"serverStatus"},{default:s(()=>[n(P,{hoverable:"","show-divider":""},{default:s(()=>[n(x,null,{default:s(()=>[u("div",tt,[u("div",null,[n(_,{class:"mr-1"},{default:s(()=>[n(a(G))]),_:1}),C(g(d.$t("commons.activeUserIn5m")),1)]),u("div",null,g($.value.active_user_in_5m),1)])]),_:1}),n(x,null,{default:s(()=>[u("div",nt,[u("div",null,[n(_,{class:"mr-1"},{default:s(()=>[n(a(G))]),_:1}),C(g(d.$t("commons.activeUserIn1h")),1)]),u("div",null,g($.value.active_user_in_1h),1)])]),_:1}),n(x,null,{default:s(()=>[u("div",ot,[u("div",null,[n(_,{class:"mr-1"},{default:s(()=>[n(a(G))]),_:1}),C(g(d.$t("commons.activeUserIn1d")),1)]),u("div",null,g($.value.active_user_in_1d),1)])]),_:1}),n(x,null,{default:s(()=>[u("div",st,[u("div",null,[n(_,{class:"mr-1"},{default:s(()=>[n(a(Ge))]),_:1}),C(g(d.$t("commons.isChatbotBusy")),1)]),u("div",null,g($.value.is_chatbot_busy?d.$t("commons.yes"):d.$t("commons.no")),1)])]),_:1}),n(x,null,{default:s(()=>[u("div",at,[u("div",null,[n(_,{class:"mr-1"},{default:s(()=>[n(a(He))]),_:1}),C(g(d.$t("commons.chatbotWaitingCount")),1)]),u("div",null,g($.value.chatbot_waiting_count),1)])]),_:1})]),_:1})]),_:1},8,["title"])]),_:1})]),_:1})}}});const it={class:"h-full flex flex-col md:flex-row md:space-x-4"},rt={class:"md:w-1/4 md:min-w-1/4 w-full flex flex-col space-y-4 md:h-full"},ut={key:0,class:"flex box-content m-2"},ct={class:"right-4 -top-12 lg:-right-10 lg:-top-8 ml-1 absolute"},dt={class:"flex flex-row space-x-2 py-2 justify-center relative",style:{height:"25px"}},vt={class:"m-2 flex flex-row justify-between"},wt=te({__name:"index",setup(se){const $=Ue(),{t:i}=ne(),j=p(),M=p(null),d=p(),T=Ce(),_=xe(),x=p(!1),P=k(()=>x.value?"50vh":"24vh"),V=()=>{x.value=!x.value},w=p(!1),A=p(!1),ae=k(()=>{var t,o,c,m;let e="";return((t=T.user)==null?void 0:t.available_ask_count)!=-1&&(e+=`${i("commons.availableAskCount")}: ${Z((o=T.user)==null?void 0:o.available_ask_count)}   `),h.value&&h.value.model_name==="gpt-4"&&((c=T.user)==null?void 0:c.available_gpt4_ask_count)!=-1&&(e+=`${i("commons.availableGPT4AskCount")}: ${Z((m=T.user)==null?void 0:m.available_gpt4_ask_count)}`),e}),l=p(null),v=p(null),h=k(()=>{var t,o;return((t=l.value)==null?void 0:t.conversation_id)===v.value?l.value:(o=_.conversations)==null?void 0:o.find(c=>c.conversation_id==v.value)}),D=p(""),S=p(null),f=p(null),O=k(()=>{var o;const e=(o=h.value)==null?void 0:o.conversation_id;if(!e)return[];let t=et(e);return Q.value.length>0&&(t=t.concat(Q.value)),t}),le=k(()=>{var o;const e=(o=_.conversations)==null?void 0:o.sort((c,m)=>{if(!c.create_time)return-1;if(!m.create_time)return 1;const y=new Date(c.create_time);return new Date(m.create_time).getTime()-y.getTime()}),t=e==null?void 0:e.map(c=>({label:()=>he(Be,null,{default:()=>c.title}),key:c.conversation_id,disabled:w.value==!0,extra:()=>$e(c,ie,re,_e)}));return l.value&&(t==null||t.unshift({label:l.value.title,key:l.value.conversation_id,disabled:w.value==!0})),t}),ie=e=>{if(!e)return;const t=ee.info({title:i("commons.confirmDialogTitle"),content:i("tips.deleteConversation"),positiveText:i("commons.confirm"),negativeText:i("commons.cancel"),onPositiveClick:()=>(t.loading=!0,new Promise(o=>{_.deleteConversation(e).then(()=>{U.success(i("tips.deleteConversationSuccess")),v.value==e&&(v.value=null)}).catch(()=>{U.error(i("tips.deleteConversationFailed"))}).finally(()=>{t.loading=!1,o(!0)})}))})},re=e=>{e&&Se(e,async t=>{await _.changeConversationTitle(e,t)},()=>{U.success(i("tips.changeConversationTitleSuccess"))},()=>{U.error(i("tips.changeConversationTitleFailed"))})},L=k(()=>{var e,t,o;if((e=h.value)!=null&&e.conversation_id)return(o=_.conversationDetailMap[(t=h.value)==null?void 0:t.conversation_id])==null?void 0:o.current_node}),Q=k(()=>{const e=[];return S.value&&e.findIndex(t=>{var o;return t.id===((o=S.value)==null?void 0:o.id)})===-1&&e.push(S.value),f.value&&e.findIndex(t=>{var o;return t.id===((o=f.value)==null?void 0:o.id)})===-1&&e.push(f.value),e});ye(v,(e,t)=>{e!="new_conversation"&&(ue(e),localStorage.removeItem("title"),localStorage.setItem("id",String(e)),console.log(localStorage.getItem("id")))});const ue=e=>{w.value||!e||(w.value=!0,A.value=!0,F.start(),_.fetchConversationHistory(e).then(()=>{}).catch(t=>{console.log(t)}).finally(()=>{w.value=!1,A.value=!1,F.finish()}))},J=k(()=>w.value||v.value==null||D.value===null||D.value.trim()==""),q=()=>{l.value||Te(async(e,t)=>{var o;console.log(e,t),l.value={conversation_id:"new_conversation",title:e||`New Chat ${new Date().toLocaleString()} - ${(o=T.user)==null?void 0:o.username}`,model_name:t||"text-davinci-002-render-sha",create_time:new Date().toISOString()},v.value="new_conversation",localStorage.removeItem("id"),localStorage.setItem("title",String(l.value.title))})},ce=e=>{e.preventDefault(),X()},W=p(!0),de=()=>{d.value.scrollTo({left:0,top:d.value.$refs.scrollbarInstRef.contentRef.scrollHeight})},ve=()=>{d.value.scrollTo({left:0,top:d.value.$refs.scrollbarInstRef.contentRef.scrollHeight,behavior:"smooth"})},X=async()=>{var N;if(J.value||w.value)return;F.start(),w.value=!0;const e=D.value;D.value="";const t={message:e};l.value?(t.new_title=l.value.title,t.model_name=l.value.model_name):(t.conversation_id=h.value.conversation_id,t.parent_id=L.value);const o=Math.random().toString(36).substring(2,16);S.value={id:`send_${o}`,message:e,author_role:"user",parent:L.value,children:[`recv_${o}`]},f.value={id:`recv_${o}`,message:"",author_role:"assistent",parent:`send_${o}`,children:[],typing:!0,model_slug:(N=h.value)==null?void 0:N.model_name};const c=De();let m=null;console.log("Connecting to",c,t);const y=new WebSocket(c);y.onopen=b=>{y.send(JSON.stringify(t))},y.onmessage=b=>{const r=JSON.parse(b.data);r.type&&(r.type==="waiting"?(f.value.message=i(r.tip),r.waiting_count&&(f.value.message+=`(${r.waiting_count})`)):r.type==="message"?(f.value.message=r.message,f.value.id=r.parent_id,f.value.model_slug=r.model_name,l.value&&(l.value.conversation_id=r.conversation_id,v.value!==l.value.conversation_id&&(v.value=l.value.conversation_id))):r.type==="error"&&(f.value.message=`${i(r.tip)}: ${r.message}}`,console.error(r.tip,r.message),r.message&&(m=r.message)),W.value&&de())},y.onclose=async b=>{if(f.value.typing=!1,console.log("WebSocket connection is closed",b),b.code===1e3){if(l.value){await _.fetchAllConversations(),v.value=l.value.conversation_id;const r=new Date(l.value.create_time).getTime()/1e3;_.$patch({conversationDetailMap:{[v.value]:{id:v.value,title:l.value.title,model_name:l.value.model_name,create_time:r,mapping:{},current_node:null}}}),_.addMessageToConversation(v.value,S.value,f.value),l.value=null}else f.value.id.startsWith("recv")||_.addMessageToConversation(v.value,S.value,f.value);S.value=null,f.value=null}else ee.error({title:i("errors.askError"),content:m!=null?`[${b.code}] ${i(b.reason)}: ${m}`:`[${b.code}] ${i(b.reason)}`,positiveText:i("commons.withdrawMessage"),onPositiveClick:()=>{S.value=null,f.value=null}});await T.fetchUserInfo(),F.finish(),w.value=!1},y.onerror=b=>{console.error("WebSocket error:",b)}},_e=()=>{if(!h.value){U.error(i("tips.pleaseSelectConversation"));return}let e=`# ${h.value.title}

`;const t=new Date(h.value.create_time+"Z").toLocaleString();e+=`Date: ${t}
Model: ${ke(h.value.model_name)}
`,e+=`generated by [ChatGPT Web Share](https://github.com/moeakwak/chatgpt-web-share)

`,e+=`---

`;let o=0;for(const m of O.value)if(m.author_role==="user"){let y=m.message.trim().split(`
`)[0];y.length>=50&&(y=y.slice(0,47)+"..."),e+=`## ${++o}. ${y}

`,e+=`### User

${m.message}

`}else e+=`### ChatGPT

${m.message}

`,e+=`---

`;const c=new Blob([e],{type:"text/plain;charset=utf-8"});Oe.saveAs(c,`${h.value.title} - ChatGPT history.md`)},me=p(),fe=p(!1);return _.fetchAllConversations().then(()=>{}),(e,t)=>{const o=Ee,c=Fe,m=oe,y=je,N=Pe,b=Ve,r=We,pe=ze,ge=Ke;return I(),z("div",{class:"flex-grow mb-4",ref_key:"rootRef",ref:j},[u("div",it,[u("div",rt,[n(lt),n(m,{class:"h-full flex-col left-col","content-style":"padding: 4px;"},{default:s(()=>[l.value?K("",!0):(I(),z("div",ut,[n(a(B),{secondary:"",strong:"",type:"primary",class:"flex-1",onClick:q,disabled:w.value},{icon:s(()=>[n(a(E),{class:""},{default:s(()=>[n(a(Le))]),_:1})]),default:s(()=>[C(" "+g(e.$t("commons.newConversation")),1)]),_:1},8,["disabled"])])),n(c,{class:"max-h-30 md:max-h-max md:min-h-0 md:flex-grow md:overflow-y-auto"},{default:s(()=>[n(o,{"content-style":{backgroundColor:"red"},ref_key:"menuRef",ref:M,disabled:w.value,options:a(le),"root-indent":18,value:v.value,"onUpdate:value":t[0]||(t[0]=R=>v.value=R)},null,8,["disabled","options","value"])]),_:1})]),_:1})]),n(m,{class:"md:w-3/4 h-full",bordered:!0,"content-style":"padding: 0; display: flex; flex-direction: column;"},{default:s(()=>[v.value?(I(),H(c,{key:0,class:"h-140 sm:h-0 flex-grow",ref_key:"historyRef",ref:d,"content-style":{height:"100%"}},{default:s(()=>[n(Ze,{ref_key:"historyContentRef",ref:me,messages:a(O),fullscreen:!1,"model-name":a(h).model_name,"show-tips":fe.value,loading:A.value},null,8,["messages","model-name","show-tips","loading"])]),_:1},512)):v.value?K("",!0):(I(),z("div",{key:1,class:"flex-grow flex flex-col justify-center",style:Y({backgroundColor:a($).cardColor})},[a(h)?K("",!0):(I(),H(y,{key:0,description:e.$t("tips.loadConversation")},{icon:s(()=>[n(a(E),null,{default:s(()=>[n(a(Qe))]),_:1})]),extra:s(()=>[n(a(B),{onClick:q},{default:s(()=>[C(g(e.$t("tips.newConversation")),1)]),_:1})]),_:1},8,["description"]))],4)),u("div",{class:"flex flex-col relative",style:Y({height:a(P)})},[n(N),u("div",ct,[n(a(B),{onClick:ve,secondary:"",circle:"",size:"small"},{icon:s(()=>[n(a(Je))]),_:1})]),u("div",dt,[n(a(B),{onClick:V,quaternary:"",circle:"",size:"small",class:"absolute left-1"},{icon:s(()=>[n(a(E),{component:x.value?a(qe):a(Xe)},null,8,["component"])]),_:1}),n(r,null,{trigger:s(()=>[n(b,{value:W.value,"onUpdate:value":t[1]||(t[1]=R=>W.value=R),size:"small",class:"absolute left-8 top-3"},{icon:s(()=>[C("A")]),_:1},8,["value"])]),default:s(()=>[C(" "+g(e.$t("tips.autoScrolling")),1)]),_:1}),n(a(B),{disabled:a(J),onClick:X,class:"absolute right-1",type:"primary",size:"small"},{icon:s(()=>[n(a(E),null,{default:s(()=>[n(a(Ye))]),_:1})]),default:s(()=>[C(g(e.$t("commons.send"))+" ",1)]),_:1},8,["disabled"])]),n(pe,{value:D.value,"onUpdate:value":t[2]||(t[2]=R=>D.value=R),class:"flex-1",type:"textarea",bordered:!1,placeholder:e.$t("tips.sendMessage"),onKeydown:we(be(ce,["shift"]),["enter"])},null,8,["value","placeholder","onKeydown"]),u("div",vt,[n(ge,{depth:"3",class:"hidden sm:block"},{default:s(()=>[C(g(a(ae)),1)]),_:1})])],4)]),_:1})])],512)}}});export{wt as default};
//# sourceMappingURL=index-46c32d53.js.map
